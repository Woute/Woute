<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta content="True" name="Handheld">
		<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
		<script src="/resources/scripts/common.js" type=text/javascript></script>
	</head>
	<script>
		'use strict';
		function getParameterByName(name, url) {
			if (!url) {
			  url = window.location.href;
			}
			name = name.replace(/[\[\]]/g, "\\$&");
			let regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
				results = regex.exec(url);
			if (!results) return null;
			if (!results[2]) return '';
			return decodeURIComponent(results[2].replace(/\+/g, " "));
		}
		let code = getParameterByName('code');
		localStorage.setItem('code', code);
		let state = getParameterByName('state');
		if (state !== localStorage.getItem('state')) {
			window.location.href = url;
		}
		let address = 'https://evescanner-gatekeeper.herokuapp.com/authenticate/' + code;
		/** 
			ToDo : Remplacer tout ce merdier par des promesses 
			http://stackoverflow.com/questions/30008114/how-do-i-promisify-native-xhr		
		**/
		httpRequest('GET', address)
		.then(response => {
			let token = JSON.parse(response).token;
			localStorage.setItem('token', token);
			window.location.href = url;
		})
	</script>
</html>
